<html>
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-162446800-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'UA-162446800-1');
    </script>

    <meta charset="utf-8"/>
    <meta
            name="viewport"
            content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about the visualization-vv-color-animate sample, read the original sample description at developers.arcgis.com.
  https://developers.arcgis.com/javascript/latest/sample-code/visualization-vv-color-animate/index.html
  -->
    <title>WhereCOVID-19 App</title>

    <link
            rel="stylesheet"
            href="https://js.arcgis.com/4.15/esri/themes/dark-blue/main.css"
    />
    <script src="https://js.arcgis.com/4.15/"></script>

    <script>
        require([
                "esri/Map",
                "esri/layers/FeatureLayer",
                "esri/views/MapView",
                "esri/core/promiseUtils",
                "esri/widgets/Legend",
                "esri/widgets/Home",
                "esri/widgets/Slider",
                "esri/widgets/Fullscreen",
                "esri/geometry/SpatialReference",
                "esri/Basemap",
                "esri/layers/MapImageLayer",
                "esri/symbols/SimpleFillSymbol",
                "esri/layers/GroupLayer",
                "esri/widgets/LayerList",
                "esri/widgets/BasemapGallery",
                "esri/widgets/Expand",
                "esri/layers/GeoJSONLayer",
                "esri/tasks/support/Query",
                "dojo/dom",
                "dojo/date",
                "dojo/date/locale",
                "dojox/data/CsvStore",
                "dojo/request",
                "dojo/DeferredList",
                "dojo/Stateful",
                "dojo/_base/declare",
                "dojo/query",
                "dojo",
            ], function (
            Map,
            FeatureLayer,
            MapView,
            promiseUtils,
            Legend,
            Home,
            Slider,
            Fullscreen,
            SpatialReference,
            Basemap,
            MapImageLayer,
            SimpleFillSymbol,
            GroupLayer,
            LayerList,
            BasemapGallery,
            Expand,
            GeoJSONLayer,
            Query,
            dom,
            date,
            locale,
            CsvStore,
            request,
            DeferredList,
            Stateful,
            declare,
            query,
            dojo,
            ) {

                // Subclass dojo/Stateful:
                const MyWatcher = declare([Stateful], {
                    active_animation_layer: null,
                    _active_animation_layerGetter: function () {
                        return this.active_animation_layer;
                    },
                    _active_animation_layerSetter: function (value) {
                        this.active_animation_layer = value;
                    }
                });

                // Create an instance and initialize some property values:
                const mywatcher = new MyWatcher({
                    active_animation_layer: null,
                });

                var production_mode = false; //true or false

                //global variables contain data
                var counties_data = null;
                var counties_data_str = null;
                var states_data = null;
                var states_data_str = null;

                // main() is called after external json file is loaded
                function main(arg1) {

                    //--------------------------------------------------------------------------
                    //
                    //  Setup Map and View
                    //
                    //--------------------------------------------------------------------------

                    // var nyt_layer_states_url = "https://services.arcgis.com/GL0fWlNkwysZaKeV/arcgis/rest/services/nyt_states_data_dev/FeatureServer/0";
                    // var nyt_layer_counties_url = "https://services.arcgis.com/GL0fWlNkwysZaKeV/arcgis/rest/services/nyt_counties_data_dev/FeatureServer/0";
                    // var illinios_county_url = "https://services.arcgis.com/GL0fWlNkwysZaKeV/arcgis/rest/services/illinois_forecast_county_dev/FeatureServer/0";
                    // var illinios_zipcode_url = "https://services.arcgis.com/GL0fWlNkwysZaKeV/arcgis/rest/services/illinois_forecast_zipcode_dev/FeatureServer/0";
                    var nyt_layer_states_url = "/preprocessing/nyt_states_data.geojson";
                    var nyt_layer_counties_url = "/preprocessing/nyt_counties_data.geojson";
                    var illinios_county_url = "/preprocessing/illinois/illinois_forecast_county.geojson";
                    var illinios_zipcode_url = "/preprocessing/illinois/illinois_forecast_zipcode.geojson";

                    if (production_mode) {
                        // nyt_layer_states_url = "https://services.arcgis.com/GL0fWlNkwysZaKeV/arcgis/rest/services/nyt_states_data/FeatureServer/0";
                        // nyt_layer_counties_url = "https://services.arcgis.com/GL0fWlNkwysZaKeV/arcgis/rest/services/nyt_counties_data/FeatureServer/0";
                        // illinios_county_url = "https://services.arcgis.com/GL0fWlNkwysZaKeV/arcgis/rest/services/illinois_forecast_county/FeatureServer/0";
                        // illinios_zipcode_url = "https://services.arcgis.com/GL0fWlNkwysZaKeV/arcgis/rest/services/illinois_forecast_zipcode/FeatureServer/0";
                        nyt_layer_states_url = "https://raw.githubusercontent.com/cybergis/cybergis.github.io/master/nyt_states_data.geojson";
                        nyt_layer_counties_url = "https://raw.githubusercontent.com/cybergis/cybergis.github.io/master/nyt_counties_data.geojson";
                        illinios_county_url = "https://raw.githubusercontent.com/cybergis/cybergis.github.io/master/illinois_forecast_county.geojson";
                        illinios_zipcode_url = "https://raw.githubusercontent.com/cybergis/cybergis.github.io/master/illinois_forecast_zipcode.geojson";
                    }

                    const default_polygon_renderer = {
                        type: "simple",
                        symbol: {
                            type: "simple-fill",
                            color: "#000000",
                            outline: {  // autocasts as new SimpleLineSymbol()
                                color: [128, 128, 128, 0.5],
                            }
                        }
                    };

                    //nyt states
                    //var nyt_layer_states = new FeatureLayer({
                    var nyt_layer_states = new GeoJSONLayer({
                        url: nyt_layer_states_url,
                        outFields: ["*"],
                        title: "US States (New York Times)",
                        visible: false,
                        renderer: default_polygon_renderer,
                    });

                    //nyt counties
                    //var nyt_layer_counties = new FeatureLayer({
                    var nyt_layer_counties = new GeoJSONLayer({
                        url: nyt_layer_counties_url,
                        outFields: ["*"],
                        title: "US Counties (New York Times)",
                        visible: true,
                        renderer: default_polygon_renderer,
                    });

                    var illinois_counties = new GeoJSONLayer({
                        url: illinios_county_url,
                        outFields: ["*"],
                        title: "Illinois Counties Forecast",
                        renderer: illinoisZipCodeRender("CountyForecast", 7, 8200),
                        visible: false,
                    });

                    var illinois_zipcode = new GeoJSONLayer({
                            url: illinios_zipcode_url,
                            outFields: ["*"],
                            title: "Illinois ZipCode Forecast",
                            renderer: illinoisZipCodeRender("ZipCodeForecast", 0, 200),
                            visible: true,
                        }
                    );

                    // order matters! last layer is at top
                    var animation_layers = [nyt_layer_states, nyt_layer_counties];
                    var static_layers = [ illinois_counties, illinois_zipcode];

                    // // new GroupLayer object may affect other GroupLayer objects
                    // // Comment out unused GroupLayer objects to avoid strange bugs
                    // // like group layer can not expand!!!!!
                    // var animationGroupLayer = new GroupLayer({
                    //     title: "Time-enabled Layers",
                    //     visible: true,
                    //     visibilityMode: "exclusive",
                    //     layers: new Array().concat(animation_layers),
                    //     opacity: 0.75
                    // });
                    // var staticGroupLayer = new GroupLayer({
                    //     title: "Static Layers",
                    //     visible: true,
                    //     visibilityMode: "exclusive",
                    //     layers: new Array().concat(static_layers),
                    //     opacity: 0.75
                    // });

                    // new GroupLayer object may affect other GroupLayer objects
                    // Comment out unused GroupLayer objects to avoid strange bugs
                    // like group layer can not expand!!!!
                    var allInOneGroupLayer = new GroupLayer({
                        title: "Layers",
                        visible: true,
                        visibilityMode: "exclusive",
                        layers: new Array().concat(animation_layers, static_layers),
                        opacity: 0.75
                    });

                    // order mattes! last layer is at top
                    //var all_layers = [animationGroupLayer, staticGroupLayer];
                    var all_layers = [allInOneGroupLayer];
                    //var all_layers = new Array().concat(animation_layers, static_layers);

                    //// A non-3857 basemap
                    // var basemap = new Basemap({
                    //                           baseLayers: [
                    //                             new MapImageLayer({
                    //                               url: "https://geoappext.nrcan.gc.ca/arcgis/rest/services/BaseMaps/CBMT3978/MapServer",
                    //                               title: "Basemap"
                    //                             })
                    //                           ],
                    //                           title: "basemap",
                    //                           id: "basemap"
                    //                         });
                    var map = new Map({
                        basemap: {
                            portalItem: {
                                id: "4f2e99ba65e34bb8af49733d9778fb8e",
                            }
                        },
                        layers: all_layers,
                    });

                    var view = new MapView({
                        map: map,
                        container: "viewDiv",
                        //spatialReference: new SpatialReference(wkid: 3857}),
                        center: [-88.984300, 40.474679],
                        zoom: 6,
                        constraints: {
                            snapToZoom: false,
                            //minScale: 72223.819286
                        },
                        // This ensures that when going fullscreen
                        // The top left corner of the view extent
                        // stays aligned with the top left corner
                        // of the view's container
                        resizeAlign: "top-left"
                    });

                    function disableDivContent(divElem, disable = true) {
                        //https://stackoverflow.com/questions/639815/how-to-disable-all-div-content/25328170
                        //https://dojotoolkit.org/reference-guide/1.7/dojo/removeClass.html
                        if (disable) {
                            dojo.addClass(divElem, "disabledbutton");
                        } else {
                            dojo.removeClass(divElem, "disabledbutton");
                        }
                    }

                    // Find the top visible layer obj in array filter_array
                    function getTopVisibleLayer(layerCol, filter_array = []) {
                        // start from the end of the array (top)
                        for (let i = layerCol.items.length - 1; i >= 0; i--) {
                            let layer = layerCol.items[i];
                            if (layer.visible) {
                                if (layer.type == "group") {
                                    let l = getTopVisibleLayer(layer.layers, filter_array);
                                    if (l != null) {
                                        return l;
                                    }
                                } else {
                                    if (filter_array.length == 0) {
                                        return layer;
                                    } else {
                                        if (filter_array.includes(layer)) {
                                            return layer
                                        }
                                    }
                                }
                            }
                        }
                        return null;
                    }

                    // called when layer order changed in layerlist control or layer visibility changed
                    function setActiveAnimationLayer(evt) {
                        stopAnimation();
                        // reset active_animation_layer
                        let topVisibleLayer = getTopVisibleLayer(map.layers, animation_layers);
                        mywatcher.set("active_animation_layer", topVisibleLayer);
                    }

                    // Manually use default top animation layer to init slider UI at startup
                    // If default top animation layer is actually invisible,
                    // it will be set disabled then as map.layers.change will be triggered at startup
                    let default_top_animation_layer = animation_layers[animation_layers.length - 1];
                    default_top_animation_layer.when(function () {
                        onActiveAnimationLayerChange("", null, default_top_animation_layer);
                    });

                    // Set up callback function for active_animation_layer value change
                    setupActiveAnimationLayerChangeCallback();

                    // This event will be triggered once at startup as maps adds layers for the fist time
                    // Listen for layer change: remove, add, reorder
                    // https://developers.arcgis.com/javascript/latest/api-reference/esri-Map.html#layers
                    map.allLayers.on("change", function (event) {
                        // this function will change active_animation_layer value
                        setActiveAnimationLayer(event);
                    });

                    // Listen for layer visibility change
                    // may get triggered more than once in if GroupLayer is in "exclusive" mode (radio button)
                    // LayerA on->off and LayerB off->on
                    // https://developers.arcgis.com/javascript/latest/sample-code/sandbox/index.html?sample=animation-layer-visibility
                    map.allLayers.forEach(function (item) {
                        item.watch("visible", function (visible) {
                            // this function will change active_animation_layer value
                            setActiveAnimationLayer(item);
                        });
                    });

                    var layerlist = new LayerList({
                        view: view,
                        //listItemCreatedFunction: defineActions,
                        selectionEnabled: true,
                        visibleElements: {statusIndicators: false},
                    });

                    // function defineActions(event) {
                    //     // The event object contains an item property.
                    //     // is is a ListItem referencing the associated layer
                    //     // and other properties. You can control the visibility of the
                    //     // item, its title, and actions using this object.
                    //
                    //     var item = event.item;
                    //
                    //     if (item.title === "Pandemic" || item.title === "Census-2000") {
                    //         // An array of objects defining actions to place in the LayerList.
                    //         // By making this array two-dimensional, you can separate similar
                    //         // actions into separate groups with a breaking line.
                    //
                    //         item.actionsSections = [
                    //             [
                    //                 {
                    //                     title: "Go to full extent",
                    //                     className: "esri-icon-zoom-out-fixed",
                    //                     id: "full-extent"
                    //                 },
                    //                 {
                    //                     title: "Layer information",
                    //                     className: "esri-icon-description",
                    //                     id: "information"
                    //                 }
                    //             ],
                    //             [
                    //                 {
                    //                     title: "Increase opacity",
                    //                     className: "esri-icon-up",
                    //                     id: "increase-opacity"
                    //                 },
                    //                 {
                    //                     title: "Decrease opacity",
                    //                     className: "esri-icon-down",
                    //                     id: "decrease-opacity"
                    //                 }
                    //             ]
                    //         ];
                    //     }
                    // }
                    //
                    // layerlist.on("trigger-action", function (event) {
                    //     // The layer visible in the view at the time of the trigger.
                    //     console.log(event);
                    //     let visibleLayer = event.item.layer;
                    //
                    //     // Capture the action id.
                    //     var id = event.action.id;
                    //
                    //     if (id === "full-extent") {
                    //         // if the full-extent action is triggered then navigate
                    //         // to the full extent of the visible layer
                    //         view.goTo(visibleLayer.fullExtent);
                    //     } else if (id === "information") {
                    //         // if the information action is triggered, then
                    //         // open the item details page of the service layer
                    //         window.open(visibleLayer.url);
                    //     } else if (id === "increase-opacity") {
                    //         // if the increase-opacity action is triggered, then
                    //         // increase the opacity of the GroupLayer by 0.25
                    //
                    //         if (visibleLayer.opacity < 1) {
                    //             visibleLayer.opacity += 0.25;
                    //         }
                    //     } else if (id === "decrease-opacity") {
                    //         // if the decrease-opacity action is triggered, then
                    //         // decrease the opacity of the GroupLayer by 0.25
                    //
                    //         if (visibleLayer.opacity > 0) {
                    //             visibleLayer.opacity -= 0.25;
                    //         }
                    //     }
                    //
                    // });

                    var basemapGallery = new BasemapGallery({
                        view: view,
                    });

                    view.ui.add(new Expand({
                        view: view,
                        content: layerlist,
                    }), "top-right");
                    view.ui.add(new Expand({
                        view: view,
                        content: basemapGallery,
                    }), "top-right");

                    //--------------------------------------------------------------------------
                    //
                    //  Setup UI
                    //
                    //--------------------------------------------------------------------------

                    var applicationDiv = document.getElementById("applicationDiv");
                    var sliderValue = document.getElementById("sliderValue");
                    var playButton = document.getElementById("playButton");
                    var titleDiv = document.getElementById("titleDiv");
                    var animation = null;
                    var slider = null;
                    var sliderDiv = document.getElementById("sliderContainer");

                    // Zero-based Month: 0==Jan
                    const dt_startConst = new Date(2020, 0, 14);
                    var dt_start = dt_startConst;
                    var dt_interval_unit = "day";


                    function queryLayerDates(_layer) {
                        const list_query = _layer.createQuery();
                        //list_query.orderByFields = ['population DESC'];
                        list_query.returnGeometry = false;
                        list_query.num = 1;
                        list_query.outFields = ["dt_start", "dt_end", "dt_unit"];
                        return _layer.queryFeatures(list_query);
                    }

                    function initSlider(response) {
                        let feature0_attrs = response.features[0].attributes;
                        let _dt_start_str = feature0_attrs["dt_start"];
                        let _dt_end_str = feature0_attrs["dt_end"];

                        if (feature0_attrs.hasOwnProperty("dt_unit")) {
                            dt_interval_unit = feature0_attrs["dt_unit"];
                        } else {
                            dt_interval_unit = "day";
                        }

                        //dt_interval_unit = "day";
                        let _dt_end = locale.parse(_dt_end_str, {datePattern: "yyyy-MM-dd", selector: "date"});
                        let _dt_start = locale.parse(_dt_start_str, {datePattern: "yyyy-MM-dd", selector: "date"});
                        dt_start = _dt_start;

                        if (dt_interval_unit == "day") {
                            dt_start = dt_startConst;
                        }

                        let _slider_max = date.difference(dt_start, _dt_end, dt_interval_unit);
                        console.log(_slider_max);


                        if (slider == null) {
                            slider = new Slider({
                                container: "slider",
                                min: 0,
                                max: _slider_max,
                                values: [0],
                                step: 1,
                                visibleElements: {rangeLabels: true},
                                draggableSegmentsEnabled: false,
                            });
                            slider.on("thumb-drag", inputHandler);
                        } else {
                            slider.min = 0;
                            slider.max = _slider_max;
                        }
                    }

                    function setupActiveAnimationLayerChangeCallback() {
                        // Watch changes on a property:
                        mywatcher.watch("active_animation_layer", onActiveAnimationLayerChange);
                    }

                    function onActiveAnimationLayerChange(name, oldValue, value) {
                        //console.log(name, oldValue, value);
                        if (value == null) {
                            disableDivContent(sliderDiv);
                        } else {
                            if (value != oldValue) {
                                // enable slider div
                                disableDivContent(sliderDiv, false);
                                queryLayerDates(value).then(initSlider).then(function () {
                                    let thumb_value = slider.values[0];
                                    if (thumb_value > slider.max || thumb_value < slider.min) {
                                        thumb_value = slider.min;
                                    }
                                    let dt_thumb = date.add(dt_start, dt_interval_unit, thumb_value);

                                    setDate(dt_thumb, animation_type = animation_type);
                                });
                            }
                        }
                    }


                    // When user drags the slider:
                    //  - stops the animation
                    //  - set the visualized year to the slider one.
                    function inputHandler(event) {
                        //console.log("Drag");
                        stopAnimation();
                        let thumb_value = Math.floor(event.value);
                        //console.log(thumb_value);
                        let dt_thumb = date.add(dt_start, dt_interval_unit, thumb_value);
                        //console.log(dt_thumb);
                        setDate(dt_thumb, animation_type = animation_type);
                    }

                    // Toggle animation on/off when user
                    // clicks on the play button
                    playButton.addEventListener("click", function () {
                        if (playButton.classList.contains("toggled")) {
                            stopAnimation();
                        } else {
                            startAnimation();
                        }
                    });

                    view.ui.empty("top-left");
                    view.ui.add(titleDiv, "top-left");
                    view.ui.add(
                        new Home({
                            view: view
                        }),
                        "top-right"
                    );
                    view.ui.add(
                        new Legend({
                            view: view
                        }),
                        "bottom-right"
                    );
                    view.ui.add(
                        new Fullscreen({
                            view: view,
                            element: applicationDiv
                        }),
                        "top-right"
                    );

                    // When the layerview is available, setup hovering interactivity
                    //view.whenLayerView(active_animation_layer).then(setupHoverTooltip);

                    var animation_dropdown = document.getElementById("animation_dropdown");
                    var animation_type = animation_dropdown.value;
                    //setDate(dt_start, animation_type = animation_type);
                    //setDate(dt_start, animation_type="first_case");

                    animation_dropdown.addEventListener("change", function (evt) {
                        //console.log(evt);
                        animation_type = evt.target.value;
                        let thumb_value = Math.ceil(slider.values[0]);

                        let current_date = date.add(dt_start, dt_interval_unit, thumb_value);
                        setDate(current_date, animation_type = animation_type);
                    });


                    var ilZipTemplate = {
                        expressionInfos: [
                            {
                                name: "zipcode",
                                title: "Zip Code",
                                expression: "Text($feature.ZipCode)"
                            },
                        ],

                        title: "{expression/zipcode}",

                        content: [
                            {
                                type: "fields", // FieldsContentElement
                                fieldInfos: [
                                    {
                                        fieldName: "ZipCode",
                                        visible: true,
                                        label: "Zip Code"
                                    },
                                    {
                                        fieldName: "MainCity",
                                        visible: true,
                                        label: "Main City"
                                    },
                                    {
                                        fieldName: "FIPS",
                                        visible: true,
                                        label: "FIPS"
                                    },
                                    {
                                        fieldName: "population",
                                        visible: true,
                                        label: "Population"
                                    },
                                    {
                                        fieldName: "ZipCodeForecast",
                                        visible: true,
                                        label: "Forecast New Cases (week Apr 5-11, 2020)"
                                    }
                                ]
                            }
                        ]
                    };

                    illinois_zipcode.popupTemplate = ilZipTemplate;

                    var ilCountyTemplate = {

                        title: "{NAME}",

                        content: [
                            {
                                type: "fields", // FieldsContentElement
                                fieldInfos: [

                                    {
                                        fieldName: "FIPS",
                                        visible: true,
                                        label: "FIPS"
                                    },
                                    {
                                        fieldName: "population",
                                        visible: true,
                                        label: "Population"
                                    },
                                    {
                                        fieldName: "CountyForecast",
                                        visible: true,
                                        label: "Forecast New Cases (week Apr 5-11, 2020)"
                                    },
                                    {
                                        fieldName: "Number_Booths",
                                        visible: true,
                                        label: "Booths"
                                    }

                                ]
                            }
                        ]
                    };

                    illinois_counties.popupTemplate = ilCountyTemplate;

                    //--------------------------------------------------------------------------
                    //
                    //  Methods
                    //
                    //--------------------------------------------------------------------------

                    /**
                     * Sets the current visualized construction year.
                     */
                    function setDate(_date, animation_type = "case") {
                        if (dt_interval_unit == "week") {
                            dt_week_end = date.add(_date, "week", 1);
                            sliderValue.innerHTML = locale.format(_date, {datePattern: "MM/dd", selector: "date"}) +
                                "-" + locale.format(dt_week_end, {datePattern: "MM/dd/yyyy", selector: "date"});
                        } else {
                            sliderValue.innerHTML = locale.format(_date, {datePattern: "MM/dd/yyyy", selector: "date"});
                        }

                        var thumb_value = date.difference(dt_start, _date, dt_interval_unit);
                        slider.viewModel.setValue(0, thumb_value);
                        let _layer = mywatcher.get("active_animation_layer");

                        if (_layer == null)
                        {return ;}

                        if (animation_type == "case") {
                            _layer.renderer = dailyEventNumberRender(_date, _event_type = "case", _scale = "loge");
                        } else if (animation_type == "death" || animation_type == "death/case" ||
                                   animation_type == "new_case" || animation_type == "new_death") {
                            _layer.renderer = dailyEventNumberRender(_date, _event_type = animation_type, _scale = "");
                        } else {
                            let event_type = "Case";
                            if (animation_type == "first_death") {
                                event_type = "Death"
                            }

                            _layer.renderer = firstEventRender(_date, _event_type = event_type);
                        }

                        //covid19_layer.renderer = dailyEventNumberRender(_date, _event_type="death/case", _scale="");
                        //covid19_layer.renderer = firstEventRender(_date, _event_type="Deaths");
                    }

                    function getDailyEventNumberArcade(_date, _event_type = "case", _scale = "") { // get accumulated Case Number
                        return `
          // be sure to use .getDate() for Day value!  NOT .getDay()!!!!!!!
          var d_thumb = Date(${_date.getFullYear()},${_date.getMonth()},${_date.getDate()});
          var event_type = '${_event_type}';
          event_type = Lower(event_type);
          var scale = '${_scale}';
          //Console(d_thumb);
          //Console($feature);

          var population = DefaultValue($feature.population, 0);

          var cases_num=0;
          var deaths_num=0;
          var cases_num_yesterday=0;
          var deaths_num_yesterday=0;
          var final_return_value = 0;


          if (IsEmpty($feature['cases_ts']))
          {
              cases_num = 0;
              deaths_num = 0;
              cases_num_yesterday=0;
              deaths_num_yesterday=0;
          }
          else
          {
            var dt_start_array = Split($feature.dt_start, '-');
            var dt_start = Date(Number(dt_start_array[0]), Number(dt_start_array[1])-1, Number(dt_start_array[2]));
              if (d_thumb < dt_start)
              {
                 cases_num = 0;
                 deaths_num = 0;
                 cases_num_yesterday=0;
                 deaths_num_yesterday=0;
              }
              else
              {
                  //var cases_ts_array = Dictionary($feature["cases_ts"]).values;
                  //var deaths_ts_array = Dictionary($feature["deaths_ts"]).values;
                  var cases_ts_array = Split($feature["cases_ts"], ',');
                  var deaths_ts_array = Split($feature["deaths_ts"], ',');


                  var days=DateDiff(d_thumb, dt_start, "days");
                  var index = Ceil(days);
                  //Console(days);
                  if(HasKey($feature, "dt_unit"))
                  {
                    if($feature["dt_unit"]=="week")
                    {
                      index=Ceil(days/7);
                    }
                  }

                  cases_num = Number(cases_ts_array[index]);
                  deaths_num = Number(deaths_ts_array[index]);
                  if(index>0)
                  {
                    cases_num_yesterday=Number(cases_ts_array[index-1]);
                    deaths_num_yesterday=Number(deaths_ts_array[index-1]);
                  }
                  else
                  {
                    cases_num_yesterday=cases_num;
                    deaths_num_yesterday=deaths_num;
                  }

              } //if (d_thumb < dt_start)
          } //if (fea_dt_start==-1)

          if (event_type=="case")
          {
             final_return_value = cases_num;
          }
          else if (event_type=="death")
          {
             final_return_value = deaths_num;
          }
          else if (event_type=="death/case")
          {
             if (cases_num>0)
             {
                final_return_value = deaths_num/cases_num;
             }
             else
             {
                final_return_value=0;
             }
          }
          else if(event_type=="case/population")
          {
             if (population >0 )
             {
             final_return_value = cases_num/population;
             }
             else
             {
             final_return_value=0;
             }
          }
          else if(event_type=="death/population")
          {
             if(population >0 )
             {
             final_return_value = deaths_num/population;
             }
             else
             {
             final_return_value=0;
             }
          }
          else if(event_type=="new_case")
          {
             final_return_value = cases_num - cases_num_yesterday;
          }
          else if(event_type=="new_death")
          {
             final_return_value = deaths_num - deaths_num_yesterday;
          }
          else
          {
             final_return_value = 0;
          }

          // scaling
          if (scale=="loge")
            {
            final_return_value = Log(final_return_value+1);
            }

            //Console(final_return_value);
            return final_return_value;

          `;
                    }

                    // Deprecated
                    function getDailyEventNumberArcade2(_date) {
                        // get accumulated Case Number if daily increase is stored
                        return `
        // start date; Month 0-based in Arcade Date class
        // be sure to use .getDate() for Day value!  NOT .getDay()!!!!!!!
        var end_dt = Date(${_date.getFullYear()},${_date.getMonth()},${_date.getDate()});
        //var end_dt = Date(2020,2,26);
        var start_dt = Date(2020,0,21);
        var days=DateDiff(end_dt, start_dt, "days");
        var sum=0;
        for(var i=0; i<=days; i++) {
        var d = DateAdd(start_dt, i, "days");
        var key=Text(d, "FY_MM_DD");
        // if attribute value is null, use 0
        var day_value = IIf(IsEmpty($feature[key]), 0, $feature[key]);
        sum += day_value;
        }
        return sum;

            `;
                    }

                    function dailyEventNumberRender(_date, _event_type="case", _scale="") {

                        const colors = ["#000000", "#fef0d9", "#fdcc8a", "#fc8d59", "#e34a33", "#b30000"];
                        let stops = [0, 0.01, 0.05, 0.10, 0.15, 0.2];
                        let labels = ["0", "1%", "5%", "10%", "15%", "20%"];

                        let event_type = _event_type.toLowerCase();

                        if (event_type == "case") {
                            //let case_max = Math.max.apply(Math, counties_data.metadata.cases);
                            let case_max = 500;

                            let interval = Math.ceil(case_max / 20);
                            stops = [0, 1, interval, 2 * interval, 3 * interval, case_max];
                            labels = stops.map(x => x.toString());
                            stops = [0, 1, interval, 2 * interval, 3 * interval, case_max];
                            stops = stops.map(x => Math.log(x));

                        } else if (event_type == "death") {
                            //let death_max = Math.max.apply(Math, counties_data.metadata.deaths);
                            let death_max = 200;

                            let interval = Math.ceil(death_max / 10);
                            stops = [0, 1, interval, 2 * interval, 3 * interval, death_max];
                            labels = stops.map(x => x.toString());

                        } else if (event_type == "death/case") {
                            stops = [0, 0.01, 0.05, 0.10, 0.15, 0.2];
                            labels = ["0", "1%", "5%", "10%", "15%", "20%"];
                        } else {
                            stops = [0, 1, 100, 500, 1000, 5000];
                            labels = stops.map(x => x.toString());

                        }

                        let stops_array = [];
                        for (let i = 0; i < colors.length; i++) {
                            let stop_item = {
                                value: stops[i],
                                color: colors[i],
                                label: labels[i].toString()
                            };
                            stops_array.push(stop_item);
                        }


                        return {
                            type: "simple",
                            symbol: {
                                type: "simple-fill",
                                color: "rgb(0, 0, 0)",
                                outline: {  // autocasts as new SimpleLineSymbol()
                                    color: [128, 128, 128, 0.5],
                                }
                            },
                            visualVariables: [
                                {
                                    type: "color",
                                    //field: 'F'+String(_date.getFullYear()).padStart(4, '0')+"_"+String(_date.getMonth()+1).padStart(2, '0')+"_"+String(_date.getDate()).padStart(2, '0'),
                                    valueExpression: getDailyEventNumberArcade(_date, _event_type = _event_type, _scale = _scale),
                                    //normalizationField: "population",
                                    valueExpressionTitle: _event_type,
                                    stops: stops_array.reverse(),
                                }
                            ]
                        };
                    }

                    function firstEventRender(_date, _event_type = "Case") {

                        return {
                            type: "simple",
                            symbol: {
                                type: "simple-fill",
                                color: "rgb(0, 0, 0)",
                                outline: {  // autocasts as new SimpleLineSymbol()
                                    color: [128, 128, 128, 0.5],
                                }
                            },
                            visualVariables: [
                                {
                                    type: "color",
                                    valueExpression: firstEventArcade(_date, _event_type = _event_type),
                                    //valueExpressionTitle: "Voter Turnout",
                                    stops: [
                                        {
                                            value: 1,
                                            color: "#f18a62",
                                            label: _event_type + "(s) Reported"
                                        },
                                        {
                                            value: 0,
                                            color: "#0ff",
                                            label: "First " + _event_type
                                        },
                                        {
                                            value: -1,
                                            color: "#000000",
                                            label: "No " + _event_type
                                        },
                                    ],
                                }
                            ]
                        };
                    }

                    function firstEventArcade(_date, _event_type = "Case") {
                        // Drew: return must be followed by the open ` on the same line, and a semi-colon ";" is required after the close `!!!
                        return `
          //be sure to use .getDate() for Day value!  NOT .getDay()!!!!!!!

          var dt_thumb = Date(${_date.getFullYear()}, ${_date.getMonth()}, ${_date.getDate()});
          var event_type = Lower('${_event_type}');
          var dt_first_event = null;
          var dt_null_string = '2099-01-01-';

           var field_name = "";
           if (event_type=="case")
           {field_name="dt_first_case";}
           else
           {field_name="dt_first_death";}
          var dt_first_event = DefaultValue($feature[field_name], dt_null_string);
          var dt_first_event_array = Split(dt_first_event, '-');
          var dt_first_event = Date(Number(dt_first_event_array[0]),
                                  Number(dt_first_event_array[1])-1,
                                  Number(dt_first_event_array[2]));

          var days=DateDiff(dt_thumb, dt_first_event, "days");
          return days;

          // // For UniqueValueRender or ClassBreakRender
          // if (days==0)
          // { return 0; }
          // else
          // {
          //   if (days>0)
          //       {return 1; }
          //   else
          //       {return -1;}
          // }

          `;
                    }

                    function firstEventRender2(_date, _event_type = "Case") {
                        var sym1 = {
                            type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                            color: "red",
                            outline: {  // autocasts as new SimpleLineSymbol()
                                color: [128, 128, 128, 0.5],
                                width: "0.5px"
                            }
                        };
                        var sym0 = {
                            type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                            color: "#0ff",
                            outline: {  // autocasts as new SimpleLineSymbol()
                                color: [128, 128, 128, 0.5],
                                width: "0.5px"
                            }
                        };
                        var sym_1 = {
                            type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                            color: "rgb(0, 0, 0)",
                            outline: {  // autocasts as new SimpleLineSymbol()
                                color: [128, 128, 128, 0.5],
                                width: "0.5px"
                            }
                        };


                        // return {
                        //   type: "unique-value",
                        //     //defaultSymbol: { type: "simple-fill",color: "yellow" },
                        //     valueExpression: firstEventArcade(_date, _event_type=_event_type),
                        //       //valueExpression: "return 0",
                        // valueExpressionTitle:
                        //   "First Event: " + _event_type,
                        //     uniqueValueInfos: [
                        //               {
                        //           value: 1,
                        //           symbol: sym1,
                        //           label: _event_type+"(s) Reported",
                        //         },
                        //         {
                        //           value: 0,
                        //           symbol: sym0,
                        //           label: "First " + _event_type,
                        //         },
                        //           {
                        //           value: -1,
                        //           symbol: sym_1,
                        //           label: "No " + _event_type,
                        //         },
                        //       ],
                        // };
                        return {
                            type: "class-breaks", // autocasts as new ClassBreaksRenderer()

                            valueExpression: firstEventArcade(_date, _event_type = _event_type),
                            classBreakInfos: [
                                {
                                    minValue: 0,
                                    maxValue: 0,
                                    symbol: sym0,
                                    label: "First Case" // label for symbol in legend
                                },
                                {
                                    minValue: 1,
                                    maxValue: 1,
                                    symbol: sym1,
                                    label: "Case(s) Reported" // label for symbol in legend
                                },
                                {
                                    minValue: -1,
                                    maxValue: -1,
                                    symbol: sym_1,
                                    label: "No Case" // label for symbol in legend
                                },
                            ]
                        };
                    }

                    function illinoisZipCodeRender(field_name, min, max) {
                        const defaultSym = {
                            type: "simple-fill", // autocasts as new SimpleFillSymbol()
                            outline: {
                                // autocasts as new SimpleLineSymbol()
                                color: [128, 128, 128, 0.8],
                                width: "0.5px"
                            }
                        };
                        const renderer = {
                            type: "simple", // autocasts as new SimpleRenderer()
                            symbol: defaultSym,
                            //label: "1-Week Ahead Forecast",
                            visualVariables: [
                                {
                                    type: "color",
                                    field: field_name, //"ZipCodeForecast",
                                    //normalizationField: "TOTPOP_CY",
                                    legendOptions: {
                                        title: "1-Week Ahead Forecast"
                                    },
                                    stops: [
                                        {
                                            value: max,
                                            color: "#FF0000",
                                            label: max.toString()
                                        },
                                        {
                                            value: min,
                                            color: "#000000",
                                            label: min.toString()
                                        }
                                    ]
                                }
                            ]
                        };
                        return renderer;

                    }

                    /**
                     * Sets up a moving tooltip that displays
                     * the construction year of the hovered building.
                     */
                    function setupHoverTooltip(layerview) {
                        var highlight;

                        var tooltip = createTooltip();

                        var hitTest = promiseUtils.debounce(function (event) {
                            return view.hitTest(event).then(function (hit) {
                                var results = hit.results.filter(function (result) {
                                    return result.graphic.layer === active_animation_layer;
                                    //return result.graphic.layer === illinois_zipcode;
                                });

                                if (!results.length) {
                                    return null;
                                }

                                return {
                                    graphic: results[0].graphic,
                                    screenPoint: hit.screenPoint
                                };
                            });
                        });

                        view.on("pointer-move", function (event) {
                            return hitTest(event).then(
                                function (hit) {
                                    // remove current highlighted feature
                                    if (highlight) {
                                        highlight.remove();
                                        highlight = null;
                                    }

                                    // highlight the hovered feature
                                    // or hide the tooltip
                                    if (hit) {
                                        var graphic = hit.graphic;
                                        var screenPoint = hit.screenPoint;

                                        highlight = layerview.highlight(graphic);
                                        console.log(graphic);
                                        tooltip.show(
                                            screenPoint,
                                            graphic.getAttribute("NAME") + ", " + graphic.getAttribute("state_name"),
                                        );
                                    } else {
                                        tooltip.hide();
                                    }
                                },
                                function () {
                                }
                            );
                        });
                    }

                    /**
                     * Starts the animation that cycle
                     * through the construction years.
                     */
                    function startAnimation() {
                        stopAnimation();
                        animation = animate(slider.values[0]);
                        playButton.classList.add("toggled");
                    }

                    /**
                     * Stops the animations
                     */
                    function stopAnimation() {
                        if (!animation) {
                            return;
                        }

                        animation.remove();
                        animation = null;
                        playButton.classList.remove("toggled");
                    }

                    /**
                     * Animates the color visual variable continously
                     */
                    function animate(startValue) {
                        var animating = true;
                        var value = startValue;

                        var frame = function (timestamp) {
                            if (!animating) {
                                return;
                            }

                            value += 1;
                            if (value > slider.max) {
                                value = slider.max;
                            }
                            var dt_thumb = date.add(dt_start, dt_interval_unit, Math.floor(value));
                            setDate(dt_thumb, animation_type = animation_type);

                            // Update at 30fps
                            setTimeout(function () {
                                requestAnimationFrame(frame);
                            }, 1000 / 10);
                        };

                        frame();

                        return {
                            remove: function () {
                                animating = false;
                            }
                        };
                    }

                    /**
                     * Creates a tooltip to display a the construction year of a building.
                     */
                    function createTooltip() {
                        var tooltip = document.createElement("div");
                        var style = tooltip.style;

                        tooltip.setAttribute("role", "tooltip");
                        tooltip.classList.add("tooltip");

                        var textElement = document.createElement("div");
                        textElement.classList.add("esri-widget");
                        tooltip.appendChild(textElement);

                        view.container.appendChild(tooltip);

                        var x = 0;
                        var y = 0;
                        var targetX = 0;
                        var targetY = 0;
                        var visible = false;

                        // move the tooltip progressively
                        function move() {
                            x += (targetX - x) * 0.1;
                            y += (targetY - y) * 0.1;

                            if (Math.abs(targetX - x) < 1 && Math.abs(targetY - y) < 1) {
                                x = targetX;
                                y = targetY;
                            } else {
                                requestAnimationFrame(move);
                            }

                            style.transform =
                                "translate3d(" + Math.round(x) + "px," + Math.round(y) + "px, 0)";
                        }

                        return {
                            show: function (point, text) {
                                if (!visible) {
                                    x = point.x;
                                    y = point.y;
                                }

                                targetX = point.x;
                                targetY = point.y;
                                style.opacity = 1;
                                visible = true;
                                textElement.innerHTML = text;

                                move();
                            },

                            hide: function () {
                                style.opacity = 0;
                                visible = false;
                            }
                        };
                    }
                }


                function pre_main() {
                    // let counties_data_json_url = "/nyt_counties_data.json";
                    // let states_data_json_url = "/nyt_states_data.json";
                    let counties_data_json_url = "";
                    let states_data_json_url = "";

                    // if (production_mode) {
                    //     // proxy to CORS
                    //     let proxy_url = "https://cors-anywhere.herokuapp.com/";
                    //     counties_data_json_url = proxy_url + "https://raw.githubusercontent.com/cybergis/cybergis.github.io/master/nyt_counties_data.json";
                    //     states_data_json_url = proxy_url + "https://raw.githubusercontent.com/cybergis/cybergis.github.io/master/nyt_states_data.json";
                    // }
                    let counties_request = request(counties_data_json_url, {handleAs: "json"});
                    let states_request = request(states_data_json_url, {handleAs: "json"});

                    let dl = new DeferredList([counties_request, states_request]);
                    return dl.then(setGlobal_JSON);
                }

                function setGlobal_JSON(res) {
                    counties_data = res[0][1];
                    //counties_data_str = JSON.stringify(counties_data);
                    states_data = res[1][1];
                    //states_data_str = JSON.stringify(states_data);

                    let promise = new Promise(function (resolve, reject) {
                        // the function is executed automatically when the promise is constructed

                        // after 1 millisecond signal that the job is done with the result "done"
                        setTimeout(() => resolve("Load JSON Done"), 1);
                    });
                    return promise;
                }

                //pre_main().then(main);
                pre_main().then(main);

            }
        );
    </script>

    <style>

        html,
        body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        #applicationDiv {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #viewDiv {
            width: 100%;
            height: 100%;
            flex: 1 1 auto;
            order: 1;
        }

        #titleDiv {
            font-weight: 400;
            font-style: normal;
            font-size: 1.2019rem;
            padding: 10px;
        }

        #sliderContainer {
            flex: 0 0 80px;
            order: 2;

            display: flex;
            flex-flow: row;

            padding: 0 12px;
        }

        #sliderValue {
            flex: 0 0 100px;
            order: 1;

            display: flex;
            justify-content: center;
            flex-direction: column;
            text-align: center;

            font-size: 300%;
        }

        #sliderInnerContainer {
            flex: 1 1 auto;
            order: 2;

            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 20px;
        }

        #slider {
            width: 100%;
        }

        /**
      * Play/Stop toggle button
      */

        #playButton {
            flex: 0 0 100px;
            order: 3;

            margin: 20px 0;
        }

        .toggle-button {
            display: flex;
        }

        .toggle-button.toggled .toggle-button-icon {
            color: #cc1b1b;
        }

        .toggle-button .toggle-button-icon {
            color: #1bcc1b;
        }

        .toggle-button > :nth-child(2) {
            display: none;
        }

        .toggle-button.toggled > :nth-child(1) {
            display: none;
        }

        .toggle-button.toggled > :nth-child(2) {
            display: block;
        }

        /**
        * Hover tooltip
        */

        .tooltip {
            position: absolute;
            pointer-events: none;
            transition: opacity 200ms;
        }

        .tooltip > div {
            margin: 0 auto;
            padding: 12px;
            border-radius: 4px;
            box-shadow: 0px 0px 4px rgba(255, 255, 255, 0.75);
            transform: translate3d(-50%, -125%, 0);
        }

        /* Enable/Disable Div and its contents*/
        .disabledbutton {
            pointer-events: none;
            opacity: 0.4;
        }
    </style>
</head>

<body>

<div id="applicationDiv">
    <div id="viewDiv">
        <div id="titleDiv" class="esri-widget">
            CyberGIS Center for Advanced Digital and Spatial Studies at University of Illinois at Urbana-Champaign
            <!--<img src="https://cybergis.illinois.edu/wp-content/themes/cybergis-new/images/uoi.png" width="20" height="30" align="top"/>-->
            <div id="subTitleDiv" class="esri-widget"> WhereCOVID-19 App</div>
        </div>
    </div>

    <div id="sliderContainer" class="esri-widget">
        <span id="sliderValue"></span>
        <div id="sliderInnerContainer">
            <div id="slider"></div>
        </div>
        <div
                id="playButton"
                class="esri-widget esri-widget--button toggle-button"
        >
            <div>
            <span
                    class="toggle-button-icon esri-icon-play"
                    aria-label="play icon"
            ></span>
                Play
            </div>
            <div>
            <span
                    class="toggle-button-icon esri-icon-pause"
                    aria-label="pause icon"
            ></span>
                Pause
            </div>
        </div>
    </div>
    <div>
        <select name="select" id="animation_dropdown" style="display: none">
            <option value="case">Cases</option>
            <option value="death">Deaths</option>
            <option value="death/case">Deaths/Cases</option>
            <option value="new_case">New Cases</option>
            <option value="new_death">New Deaths</option>
            <option value="first_case" selected="selected">First Case Report</option>
            <option value="first_death">First Death Report</option>
        </select>
    </div>

</div>

</body>
</html>
